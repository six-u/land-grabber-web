let e=document.createElement("style");e.innerHTML=".draw-canvas{width:1366px;height:700px}.map{position:relative;width:1366px;height:700px;margin:auto;overflow:hidden}.map .ui{color:#fff;text-shadow:0 0 3px #000;font-size:16px}.map .ui .timer{position:absolute;top:11px;left:110px}.map .ui .tax{position:absolute;top:8px;right:30px;font-size:24px}.map .ui .reset{position:absolute;top:4px;left:8px;padding:8px;cursor:pointer}.map .ui .level{position:absolute;top:11px;right:120px;font-size:14px;cursor:default}.map .mask{position:absolute;top:0;left:0;z-index:2;width:100%;height:100%;background-color:rgba(66,66,66,.75);background-size:100%;color:#fff;text-shadow:0 0 3px #000;font-size:16px}.map .mask .start{position:absolute;top:50%;left:50%;margin-left:-44px;margin-top:-28px;padding:8px 16px;font-size:3em;font-weight:700;text-shadow:0 0 5px #000;cursor:pointer;z-index:2}.map .mask .gameover{width:360px;height:360px;position:absolute;left:0;top:0;right:0;bottom:0;margin:auto;background-color:#fff;text-shadow:0 0 3px #000;font-size:24px;letter-spacing:3px;z-index:4}.map .mask .gameover.success{background:url(./img/shield_win.png) 0 0/100% 100% no-repeat}.map .mask .gameover.fail{background:url(./img/shield_defeat.png) 0 0/100% 100% no-repeat}.map .mask .gameover .player-name{padding-top:105px}.map .mask .gameover .status{padding-top:25px}.map .mask .sword{width:144px;height:576px;background:url(./img/sword.png) 0 0/100% 100% no-repeat;position:absolute;top:20px;z-index:3}.map .mask .sword.left{left:600px;animation:.5s ease-out swordLeft;transform:rotate(-35deg)}.map .mask .sword.right{right:600px;animation:.5s ease-out swordRight;transform:rotate(35deg)}@keyframes swordLeft{0%{transform:rotate(-270deg);left:-500px;top:500px}98%{left:580px;top:0}}@keyframes swordRight{0%{transform:rotate(270deg);right:-500px;top:500px}98%{right:580px;top:0}}.map .mask .settle{width:600px;height:620px;margin:auto;background:url(./img/settle.png) 0 0/100% no-repeat;position:relative}.map .mask .settle.fail{filter:grayscale(.7)}.map .mask .settle .title{padding-top:200px;font-size:1.3em}.map .mask .settle .used-time{padding-top:10px;font-size:1.2em}.map .mask .settle .time-rate{padding-top:10px;font-size:1.5em;font-weight:700}.map .mask .settle .time-target{padding-top:10px;font-size:.8em;font-weight:700}.map .mask .settle .l0{color:#fe745b}.map .mask .settle .l1{color:#f3c736}.map .mask .settle .l2{color:#00ad4f}.map .mask .settle .l3{color:#a08ec9}.map .mask .settle .settle-box{padding:10px 50px;overflow:hidden}.map .mask .settle .settle-item{padding:12px 10px;float:left;width:230px}.map .mask .settle .settle-item .label{padding-left:40px;text-align:left}.map .mask .settle .settle-item .value{padding-top:8px}.map .mask .settle .btn{position:absolute;left:0;right:0;bottom:108px;margin:auto;letter-spacing:2px;font-size:1.1em;cursor:pointer}",document.head.appendChild(e);import{g as t,o as a,c as s,a as i,h as l,b as o,t as r,F as n,r as m}from"./index.53ac35b0.js";import{m as d}from"./index.0053615e.js";const h={yellow:"#eadf0f",green:"#00ad4f",blue:"#5d80e1",gray:"#918176",red:"#fe745b"},c={red:["#fe745b1a","#fe745b7a"],blue:["#5d80e11a","#5d80e17a"],green:["#00ad4f1a","#00ad4f7a"],yellow:["#eadf0f1a","#eadf0f7a"],gray:["#9181761a","#9181767a"]},p={1:80,2:95,3:110,4:130,5:150},u={w:48,h:48,row:7,col:21},g={w:32,h:32,row:4,col:32},f={w:32,h:48,row:4,col:32},v={1:22,2:215,3:465,4:410,5:500,6:225,7:960,8:530,9:900},w=["你打破了大师记录","优异成绩","合格","至少你赢了"];let x,y;var b={name:"Canvas",props:{mapLevel:{rquired:!0,type:Number,default:1},roads:{required:!0},drawTimer:0},data:()=>({ourSelectImg:"",enemySelectImg:"",soldierImg:"",frame:[0,3,7],count:0,barWidth:0}),mounted(){this.initDraw(),this.barWidth=document.getElementById("canvasBox").offsetWidth-150},beforeUnmount(){this.backMusicPause()},methods:{initDraw(){this.createSelectImgDOM();let e=document.getElementById("canvasBox");x=document.getElementById("mapCanvas");let t=Math.round(x.offsetLeft/2);x.width=e.clientWidth,x.height=e.clientHeight,y=x.getContext("2d"),this.drawRoads(),this.drawBuilds(),this.drawPopulationBar(),this.drawUI(),x.addEventListener("click",(e=>{let[a,s]=this.locateBuild(e.x-t,e.y,"cl");if(s)a.levelUp(this.LGRT);else if(a){this.LGRT.interactive(!0,a,this.LGRT.actionBuild)&&(this.LGRT.actionBuild={})}})),x.addEventListener("mousemove",(e=>{this.locateBuild(e.x-t,e.y,"mv")})),x.addEventListener("dblclick",(e=>{let[a]=this.locateBuild(e.x-t,e.y,"dbl");if(a){this.LGRT.interactive(!1,a,this.LGRT.actionBuild)&&(this.LGRT.actionBuild={})}})),x.addEventListener("contextmenu",(e=>{this.soundEffectPlay("unselect"),this.LGRT.unSelect()}))},clearCanvas(){y.clearRect(0,0,x.width,x.height)},createSelectImgDOM(){this.ourSelectImg=new Image,this.ourSelectImg.src="./img/our_selector.png",this.enemySelectImg=new Image,this.enemySelectImg.src="./img/enemy_selector.png",this.soldierImg=new Image,this.soldierImg.src="./img/animation/Armor_blue.png"},locateBuild(e,t,a){let s,i,l,o,r=Object.values(this.LGRT.buildList),n=r.length;for(;n>0;){let m=r[n-1];if(s=m.x-40,i=m.x+40,l=m.y-64,o=m.y+16,e>m.x+44&&e<m.x+54&&t>m.y-45&&t<m.y-25)return!m.isUping&&m.population>5*m.level?[m,!0]:[m,!1];if(e>s&&e<i&&t>l&&t<o){if("cl"==a)return m.isPlayer&&(m.selected=!0),this.backMusicPlay("select"),[m,!1];if("mv"==a&&(m.hover=!0),"dbl"==a)return[m,!1]}else m.hover=!1;n--}return["",!1]},drawRoads(){y.lineJoin="round",y.lineWidth=45,this.roads.forEach((e=>{y.strokeStyle="#333",y.beginPath(),y.moveTo(e[0]+1,e[1]+1),y.lineTo(e[2]+1,e[3]+1),y.stroke(),y.closePath(),y.stroke(),y.strokeStyle="#e4fdeb",y.beginPath(),y.moveTo(e[0],e[1]),y.lineTo(e[2],e[3]),y.stroke(),y.closePath(),y.stroke()}))},drawBuilds(){Object.values(this.LGRT.buildList).forEach((e=>{y.drawImage(this.buildImgList[`${e.type}_${e.faction}_${e.level}`],e.x-64,e.y-96,128,128),"Tower"==e.type&&(y.lineWidth=1,y.beginPath(),y.arc(e.x,e.y-16,p[e.level],0,2*Math.PI),y.fillStyle=c[e.faction][0],y.fill(),y.beginPath(),y.strokeStyle=c[e.faction][1],y.arc(e.x,e.y-16,p[e.level],0,2*Math.PI),y.stroke()),y.lineJoin="round",y.lineWidth=16,y.strokeStyle=h[e.faction],y.beginPath(),y.moveTo(e.x-16,e.y+25),y.lineTo(e.x+20,e.y+25),y.closePath(),y.stroke(),y.font="16px STheiti, SimHei",y.fillStyle="#fff",y.fillText(e.population+"/"+10*e.level,e.x-16,e.y+30),e.isPlayer&&e.level<5&&!e.isUping&&e.population>5*e.level&&(y.lineJoin="round",y.lineWidth=1,y.beginPath(),y.fillStyle=e.faction,y.moveTo(e.x+44,e.y-45),y.lineTo(e.x+54,e.y-35),y.lineTo(e.x+48,e.y-35),y.lineTo(e.x+48,e.y-25),y.lineTo(e.x+40,e.y-25),y.lineTo(e.x+40,e.y-35),y.lineTo(e.x+34,e.y-35),y.closePath(),y.fill()),e.isUping&&(y.lineWidth=3,y.beginPath(),y.strokeStyle=h[e.faction],y.arc(e.x+44,e.y-45,10,0,this.frame[0]%36*10*Math.PI/180),y.stroke())}))},drawPopulationBar(){let e=50,a=680,s=Object.values(this.LGRT.users).filter((e=>{if(e.idx)return e})),i=s.length;for(let l=0;l<i;l++){let i=s[l];if(i.faction!=t.Gray){let t=Object.values(i.buildList).reduce(((e,t)=>10*t.level+e),0),s=Math.round(t/this.LGRT.totalPopulation*this.barWidth);if(y.strokeStyle="#999",y.lineWidth=20,y.beginPath(),y.moveTo(e-2,a),y.lineTo(e+s+2,a),y.stroke(),y.closePath(),y.strokeStyle=h[i.faction],y.lineWidth=18,y.beginPath(),y.moveTo(e,a),y.lineTo(e+s,a),y.stroke(),y.closePath(),e+=s,s==this.barWidth){window.cancelAnimationFrame(this.drawTimer),this.LGRT.gameOver(i),this.$emit("gameOver",i);break}}}},drawSolders(){Object.values(this.LGRT.actionSoldier).forEach((e=>{if("Cavalry"==e.type){let t=this.calcCoordinate(e.vector,this.frame[0],u.col,u.w,u.h),a=this.calcCoordinate(e.vector,this.frame[1],u.col,u.w,u.h),s=this.calcCoordinate(e.vector,this.frame[2],u.col,u.w,u.h);e.health>2&&y.drawImage(this.solderImgList[`${e.type}_${e.faction}`],t.left,t.top,u.w,u.h,e.x-u.w/2-16,e.y-u.w/2-8,u.w,u.h),e.health>1&&y.drawImage(this.solderImgList[`${e.type}_${e.faction}`],a.left,a.top,u.w,u.h,e.x-u.w/2+16,e.y-u.w/2-8,u.w,u.h),1==e.health&&y.drawImage(this.solderImgList[`${e.type}_${e.faction}_flag`],s.left,s.top,u.w,u.h,e.x-u.w/2,e.y-32,u.w,u.h)}else{let t=this.calcCoordinate(e.vector,this.frame[0],g.col,g.w,g.h),a=this.calcCoordinate(e.vector,this.frame[1],g.col,g.w,g.h),s=this.calcCoordinate(e.vector,this.frame[2],f.col,f.w,f.h);y.drawImage(this.solderImgList[`${e.type}_${e.faction}`],t.left,t.top,g.w,g.h,e.x-g.w/2-16,e.y-g.w/2-8,g.w,g.h),y.drawImage(this.solderImgList[`${e.type}_${e.faction}`],a.left,a.top,g.w,g.h,e.x-g.w/2+16,e.y-g.h/2-8,g.w,g.h),y.drawImage(this.solderImgList[`${e.type}_${e.faction}_flag`],s.left,s.top,f.w,f.h,e.x-f.w/2,e.y-f.h/2,f.w,f.h)}}))},drawBlood(){Object.values(this.LGRT.deadSoldier).forEach((e=>{y.drawImage(this.bloodImgList[`blood_0${e.health}`],0,0,24,24,e.ex,e.ey,24,24)}))},calcCoordinate:(e,t,a,s,i)=>({left:(8*e+t%8)%a*s,top:Math.floor((8*e+t%8)/a)*i+4}),drawBuildSelect(){Object.values(this.LGRT.buildList).forEach((e=>{(e.selected||e.hover)&&(e.isPlayer?y.drawImage(this.ourSelectImg,e.x-54,e.y-66,112,112):y.drawImage(this.enemySelectImg,e.x-54,e.y-66,112,112))}))},drawUI(){y.drawImage(this.uiImg,512,0,256,128,0,0,224,112),y.drawImage(this.uiImg,768,0,256,128,1142,0,224,112)},draw(){this.clearCanvas(),this.drawRoads(),this.drawBlood(),Object.keys(this.LGRT.actionSoldier).length&&this.drawSolders(),this.drawBuilds(),this.drawBuildSelect(),this.drawPopulationBar(),this.drawUI(),this.count%2==0&&(this.frame[0]++,this.frame[1]++,this.frame[2]++),this.count++,"start"==this.LGRT.status&&(this.drawTimer=window.requestAnimationFrame(this.draw))}}};const T={class:"draw-canvas",id:"canvasBox"},k=i("canvas",{id:"mapCanvas"},null,-1);b.render=function(e,t,i,l,o,r){return a(),s("div",T,[k])};var S={name:"map",components:{Canvas:b},data:()=>({LGRTStatus:"no-start",level:1,user:[],builds:[],roads:[],loading:!1,playTime:"00:00:00",tax:0,showHelp:!1,step:1,page:1,playerName:"",timeTarget:"00:05:01",playerSettleData:{timeConsuming:0,maxPopulation:0,maxBuild:0,sendTroopNum:0,battleDamage:0,internalFriction:0},winnerSettleData:{faciton:"",timeConsuming:0,maxPopulation:0,maxBuild:0,sendTroopNum:0,battleDamage:0,internalFriction:0},rateStr:[]}),created(){this.$route.params.level?(this.level=Number(this.$route.params.level),sessionStorage.setItem("maplvl",this.level)):this.level=Number(sessionStorage.getItem("maplvl")),this.playerName=localStorage.getItem("usr"),this.rateStr=w,this.timeTarget=this.getTimeString(v[this.level]);let e=d[this.level];this.user=l(e.user),this.builds=l(e.builds),this.roads=l(e.roads),this.LGRT.init(this.user,this.builds,this.roads),this.loading=!0,setInterval((()=>{this.playTime=this.getTimeString(this.LGRT.playTimes),this.tax=Object.values(this.LGRT.users).filter((e=>{if(e.isPlayer)return e}))[0].tax}),1e3);let t=Math.round(5*Math.random())+1;this.backMusicPlay("map"+t)},beforeUnmount(){this.backMusicPause()},methods:{getTimeString(e){let t=Math.floor(e/3600),a=e-3600*t,s=Math.floor(a/60),i=Math.floor(a%60);return t=t<10?"0"+t:""+t,s=s<10?"0"+s:""+s,i=i<10?"0"+i:""+i,t+":"+s+":"+i},start(){this.LGRT.start(),this.LGRTStatus="start",this.$refs.canvas.draw(),sessionStorage.setItem("STStamp",(new Date).getTime())},gameOver(e){if(this.playerSettleData={...this.LGRT.userSettlementData},this.winnerSettleData={faciton:e.faciton,...this.LGRT.winnerSettlementData},this.page=1,setTimeout((()=>{this.page=2}),2e3),this.backMusicPause(),e.isPlayer){this.LGRTStatus="success",localStorage.setItem("maplvl",1+this.level),0==this.timeRate()?this.backMusicPlay("flawless_victory",!1):this.backMusicPlay("victory",!1)}else this.LGRTStatus="fail",this.backMusicPlay("defeat",!1)},timeRate(){let e=this.LGRT.playTimes-v[this.level];return e<=0?0:e>0&&e<=3e4?1:e>3e4&&e<12e4?2:3},overDown(){"success"==this.LGRTStatus?this.$router.push({name:"list"}):this.reset()},reset(){location.reload()}}};const L={class:"map"},R={class:"ui"},I={class:"level"},G={class:"timer"},P={class:"tax"},B={key:1,class:"mask"},C={key:0,class:"start"},D={class:"player-name"},M={class:"status"},$=i("div",{class:"sword left"},null,-1),O=i("div",{class:"sword right"},null,-1),_={class:"title"},z={class:"used-time"},E={key:1,class:"time-rate"},W={class:"settle-box"},j={class:"settle-item"},N=i("p",{class:"label"},"最大人口数：",-1),U={class:"value"},F={class:"settle-item"},H=i("p",{class:"label"},"派出士兵：",-1),q={class:"value"},A={class:"settle-item"},J=i("p",{class:"label"},"最大建筑数：",-1),K={class:"value"},Q={class:"settle-item"},V=i("p",{class:"label"},"损失士兵：",-1),X={class:"value"};S.render=function(e,t,l,d,h,c){const p=m("Canvas");return a(),s("div",L,[h.loading?(a(),s(p,{key:0,ref:"canvas",mapLevel:Number(h.level),roads:h.roads,onGameOver:c.gameOver},null,8,["mapLevel","roads","onGameOver"])):o("",!0),i("div",R,[i("div",{class:"reset",onClick:t[1]||(t[1]=(...e)=>c.reset&&c.reset(...e))},"重玩此关"),i("div",I,"关卡 "+r(h.level),1),i("div",G,r(h.playTime),1),i("div",P,r(h.tax),1)]),"start"!=h.LGRTStatus?(a(),s("div",B,["no-start"==h.LGRTStatus||"pause"==h.LGRTStatus?(a(),s("div",C,[i("p",{onClick:t[2]||(t[2]=(...e)=>c.start&&c.start(...e))},"Start")])):o("",!0),"success"==h.LGRTStatus||"fail"==h.LGRTStatus?(a(),s(n,{key:1},[1==h.page?(a(),s(n,{key:0},[i("div",{class:["gameover",h.LGRTStatus]},[i("div",D,r(h.playerName),1),i("div",M,r(h.LGRTStatus),1)],2),$,O],64)):o("",!0),2==h.page?(a(),s("div",{key:1,class:["settle",{fail:"fail"==h.LGRTStatus}]},[i("p",_,r("success"==h.LGRTStatus?"恭喜你":"很遗憾")+", "+r(h.playerName),1),i("p",z,r(h.playTime),1),"success"==h.LGRTStatus?(a(),s(n,{key:0},[i("p",{class:["time-rate","l"+c.timeRate()]},r(h.rateStr[c.timeRate()]),3),i("p",{class:["time-target","l"+c.timeRate()]},"（需要挑战的时间是："+r(h.timeTarget)+"）",3)],64)):o("",!0),"fail"==h.LGRTStatus?(a(),s("p",E,"你输了， "+r(e.LGRT.winnerFaction)+" 获胜！",1)):o("",!0),i("div",W,[i("div",j,[N,i("p",U,r(e.LGRT.userSettlementData.maxPopulation),1)]),i("div",F,[H,i("p",q,r(e.LGRT.userSettlementData.sendTroopNum),1)]),i("div",A,[J,i("p",K,r(e.LGRT.userSettlementData.maxBuild),1)]),i("div",Q,[V,i("p",X,r(e.LGRT.userSettlementData.battleDamage+e.LGRT.userSettlementData.internalFriction),1)])]),i("div",{class:"btn",onClick:t[3]||(t[3]=(...e)=>c.overDown&&c.overDown(...e))},r("success"==h.LGRTStatus?"下一关":"重新开始"),1)],2)):o("",!0)],64)):o("",!0)])):o("",!0)])};export default S;
